version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${REPOSITORY_URI}

  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t ${REPOSITORY_URI}:latest .
      - docker tag ${REPOSITORY_URI}:latest ${REPOSITORY_URI}:${IMAGE_TAG}

post_build:
  commands:
    - echo Build completed on `date`
    - echo Pushing the Docker images...
    - docker push ${REPOSITORY_URI}:latest
    - docker push ${REPOSITORY_URI}:${IMAGE_TAG}
    - echo Writing image definitions file...
    - echo '[{"name":"nodejs-mysql-app","imageUri":"'"${REPOSITORY_URI}:${IMAGE_TAG}"'"}]' > imagedefinitions.json
      # - aws ecs update-service --cluster $ECS_CLUSTER --service $ECS_SERVICE --force-new-deployment
artifacts:
  files:
    - '**/*'
    - appspec.yml
    - imagedefinitions.json
  discard-paths: yes
